var User = require('mongoose').model('user');
var Question = require('mongoose').model('question');
var passport = require('passport');
var funct= require('./functions.server.controller');

//TAKE TIME TO RESTRUCTURE THIS FUNCTION
exports.saveOAuthUserProfile = function (req, profile, done) {//REFERRING TO PROFILE GENERATED BY VAR providerUserProfile IN FACEBOOK.JS
    
    User.findOne({//see if user has account oauth account in db
        provider: profile.provider,
        providerId: profile.providerId
    }, function (err, user) {
        if (err) {//if error with query
            return done(err);
        } else {//if query run successfully
            if (!user) {//if no oauth info
                //they have no account at all with thug report
                var possibleUsername = profile.username ||
                        ((profile.email) ? profile.email.split('@')[0] : '');
                User.findUniqueUsername(possibleUsername, null,
                function (availableUsername) {
                    profile.username = availableUsername;
                    user = new User(profile);
                    user.save(function (err) {
                        if (err) {
                            var message = err;
                            req.flash('error', message);
                           return res.redirect('/signup');//TOD0--why is res undefined? why is response object not avail in here?s
                        }
                        return done(err, user);
                    });
                });
                //they have an account with thug report and have not linked it with oauth
            } else {
                return done(err, user);
            }
        }
    });
};